import{r as d,b as m,e as _,t as f,u as p,o as w}from"./B19HXUBU.js";const x=new Error("request for lock canceled");var y=function(o,e,t,i){function u(s){return s instanceof t?s:new t(function(n){n(s)})}return new(t||(t=Promise))(function(s,n){function a(r){try{c(i.next(r))}catch(l){n(l)}}function h(r){try{c(i.throw(r))}catch(l){n(l)}}function c(r){r.done?s(r.value):u(r.value).then(a,h)}c((i=i.apply(o,e||[])).next())})};class q{constructor(e,t=x){this._value=e,this._cancelError=t,this._queue=[],this._weightedWaiters=[]}acquire(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((i,u)=>{const s={resolve:i,reject:u,weight:e,priority:t},n=v(this._queue,a=>t<=a.priority);n===-1&&e<=this._value?this._dispatchItem(s):this._queue.splice(n+1,0,s)})}runExclusive(e){return y(this,arguments,void 0,function*(t,i=1,u=0){const[s,n]=yield this.acquire(i,u);try{return yield t(s)}finally{n()}})}waitForUnlock(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return this._couldLockImmediately(e,t)?Promise.resolve():new Promise(i=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),E(this._weightedWaiters[e-1],{resolve:i,priority:t})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatchQueue()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatchQueue()}cancel(){this._queue.forEach(e=>e.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(e){const t=this._value;this._value-=e.weight,e.resolve([t,this._newReleaser(e.weight)])}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let e=this._value;e>0;e--){const t=this._weightedWaiters[e-1];t&&(t.forEach(i=>i.resolve()),this._weightedWaiters[e-1]=[])}else{const e=this._queue[0].priority;for(let t=this._value;t>0;t--){const i=this._weightedWaiters[t-1];if(!i)continue;const u=i.findIndex(s=>s.priority<=e);(u===-1?i:i.splice(0,u)).forEach(s=>s.resolve())}}}_couldLockImmediately(e,t){return(this._queue.length===0||this._queue[0].priority<t)&&e<=this._value}}function E(o,e){const t=v(o,i=>e.priority<=i.priority);o.splice(t+1,0,e)}function v(o,e){for(let t=o.length-1;t>=0;t--)if(e(o[t]))return t;return-1}var k=function(o,e,t,i){function u(s){return s instanceof t?s:new t(function(n){n(s)})}return new(t||(t=Promise))(function(s,n){function a(r){try{c(i.next(r))}catch(l){n(l)}}function h(r){try{c(i.throw(r))}catch(l){n(l)}}function c(r){r.done?s(r.value):u(r.value).then(a,h)}c((i=i.apply(o,e||[])).next())})};class W{constructor(e){this._semaphore=new q(1,e)}acquire(){return k(this,arguments,void 0,function*(e=0){const[,t]=yield this._semaphore.acquire(1,e);return t})}runExclusive(e,t=0){return this._semaphore.runExclusive(()=>e(),1,t)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(e=0){return this._semaphore.waitForUnlock(1,e)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}const $={class:"flex justify-around"},M={class:"w-1/2 m-4"},g=_("span",{class:"text-xl"},"Counter Without Mutex",-1),C={class:"mt-4"},I={class:"w-1/2 m-4"},L=_("span",{pan:"",class:"text-xl"},"Counter With Mutex",-1),F={class:"mt-4"},b={__name:"mutex",setup(o){const e=new W,t=d(""),i=d("");let u=0,s=0;n(1,500),n(2,200),n(3,500),n(4,100),a(1,500),a(2,200),a(3,500),a(4,100);function n(h,c){t.value+=`Execute: ${h}
`,setTimeout(()=>{u++,t.value+=`Finish: ${h}
`,t.value+=`new counter is: ${u}
`},c)}function a(h,c){i.value+=`Execute: ${h}
`,e.acquire().then(function(r){setTimeout(()=>{s++,i.value+=`Finish: ${h}
`,i.value+=`new counter is: ${s}
`,r()},c)})}return(h,c)=>(w(),m("div",$,[_("div",M,[g,_("pre",C,""+f(p(t))+`
      `,1)]),_("div",I,[L,_("pre",F,""+f(p(i))+`
      `,1)])]))}};export{b as default};
